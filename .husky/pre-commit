#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# BMAD Git Hooks Automation - Pre-commit Hook
# Requirements: 1.1, 1.3, 1.4

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# Execute pre-commit hook through Hook Orchestrator
node -e "
const HookOrchestrator = require('./scripts/hooks/hook-orchestrator');
const orchestrator = new HookOrchestrator();

async function runPreCommit() {
  try {
    const stagedFiles = process.env.STAGED_FILES ? process.env.STAGED_FILES.split('\n').filter(f => f.length > 0) : [];
    console.log('ðŸ” Running pre-commit validation...');
    
    const result = await orchestrator.executePreCommit(stagedFiles);
    
    if (result.success) {
      console.log('âœ… Pre-commit validation passed');
      console.log(\`â±ï¸  Completed in \${result.duration}ms\`);
      
      // Log summary of what was validated
      const validations = Object.entries(result.results).filter(([_, r]) => r.status !== 'skipped');
      if (validations.length > 0) {
        console.log('ðŸ“‹ Validations performed:');
        validations.forEach(([name, result]) => {
          const status = result.status === 'passed' ? 'âœ…' : result.status === 'warning' ? 'âš ï¸' : 'âŒ';
          console.log(\`   \${status} \${name}: \${result.status}\`);
        });
      }
      
      process.exit(0);
    } else {
      console.error('âŒ Pre-commit validation failed');
      console.error(\`â±ï¸  Failed after \${result.duration}ms\`);
      
      // Show detailed error information
      Object.entries(result.results).forEach(([name, result]) => {
        if (result.status === 'failed') {
          console.error(\`\\nðŸš« \${name} failed:\`);
          if (result.error) {
            console.error(\`   Error: \${result.error}\`);
          }
          if (result.output) {
            console.error(\`   Output: \${result.output}\`);
          }
        }
      });
      
      if (result.error) {
        console.error(\`\\nðŸ’¥ Hook execution error: \${result.error}\`);
      }
      
      process.exit(1);
    }
  } catch (error) {
    console.error('ðŸ’¥ Pre-commit hook crashed:', error.message);
    process.exit(1);
  }
}

runPreCommit();
" STAGED_FILES="$STAGED_FILES"