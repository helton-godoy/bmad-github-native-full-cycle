#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# BMAD Git Hooks Automation - Commit Message Hook
# Requirements: 2.1, 2.2, 2.3, 2.4

# Get commit message from file
COMMIT_MSG_FILE="$1"

# Check if commit message file exists
if [ ! -f "$COMMIT_MSG_FILE" ]; then
  echo "âŒ Error: Commit message file not found: $COMMIT_MSG_FILE"
  exit 1
fi

# Execute commit message validation through Hook Orchestrator
node -e "
const fs = require('fs');
const HookOrchestrator = require('./scripts/hooks/hook-orchestrator');

async function runCommitMsgValidation() {
  try {
    const commitMsgFile = process.argv[1];
    
    if (!fs.existsSync(commitMsgFile)) {
      console.error('âŒ Commit message file not found:', commitMsgFile);
      process.exit(1);
    }
    
    const message = fs.readFileSync(commitMsgFile, 'utf8').trim();
    
    if (!message) {
      console.error('âŒ Commit message is empty');
      process.exit(1);
    }
    
    console.log('ðŸ” Validating commit message...');
    console.log(\`ðŸ“ Message: \${message}\`);
    
    const orchestrator = new HookOrchestrator();
    const result = await orchestrator.executeCommitMsg(message);
    
    if (result.success) {
      console.log('âœ… Commit message validation passed');
      console.log(\`ðŸ“‹ Format: \${result.validationSummary}\`);
      console.log(\`â±ï¸  Completed in \${result.duration}ms\`);
      
      // Show validation details
      if (result.results.messageValidation.format === 'bmad' && result.results.messageValidation.parsed) {
        const parsed = result.results.messageValidation.parsed;
        console.log(\`ðŸ‘¤ Persona: \${parsed.persona}\`);
        console.log(\`ðŸ”¢ Step ID: \${parsed.stepId}\`);
        console.log(\`ðŸ“„ Description: \${parsed.description}\`);
      }
      
      // Show warnings if any
      if (result.results.messageValidation.warnings && result.results.messageValidation.warnings.length > 0) {
        console.log('âš ï¸  Warnings:');
        result.results.messageValidation.warnings.forEach(warning => {
          console.log(\`   â€¢ \${warning}\`);
        });
      }
      
      // Show bypass information if applicable
      if (result.results.bypass && result.results.bypass.bypassed) {
        console.log(\`ðŸšª Bypassed: \${result.results.bypass.reason}\`);
      }
      
      process.exit(0);
    } else {
      console.error('âŒ Commit message validation failed');
      console.error(\`â±ï¸  Failed after \${result.duration}ms\`);
      
      // Show detailed error message
      if (result.errorMessage) {
        console.error('\\n' + result.errorMessage);
      }
      
      // Show remediation guidance
      if (result.remediation) {
        console.error('\\nðŸ”§ REMEDIATION STEPS:');
        result.remediation.steps.forEach((step, index) => {
          console.error(\`   \${index + 1}. \${step}\`);
        });
        
        if (result.remediation.examples.length > 0) {
          console.error('\\nðŸ’¡ EXAMPLES:');
          result.remediation.examples.forEach(example => {
            console.error(\`   â€¢ \${example}\`);
          });
        }
        
        if (result.remediation.quickFixes.length > 0) {
          console.error('\\nâš¡ QUICK FIXES:');
          result.remediation.quickFixes.forEach(fix => {
            console.error(\`   â€¢ \${fix}\`);
          });
        }
      }
      
      // Show validation details for debugging
      if (result.results.messageValidation && result.results.messageValidation.errors) {
        console.error('\\nðŸ› VALIDATION ERRORS:');
        result.results.messageValidation.errors.forEach((error, index) => {
          console.error(\`   \${index + 1}. \${error}\`);
        });
      }
      
      process.exit(1);
    }
  } catch (error) {
    console.error('ðŸ’¥ Commit message validation crashed:', error.message);
    console.error('Stack trace:', error.stack);
    process.exit(1);
  }
}

runCommitMsgValidation();
" "$COMMIT_MSG_FILE"